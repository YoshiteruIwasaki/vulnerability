package jp.rte.core.service;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import org.slim3.memcache.Memcache;

import jp.rte.core.model.Feed;

import com.sun.syndication.feed.synd.SyndContent;
import com.sun.syndication.feed.synd.SyndContentImpl;
import com.sun.syndication.feed.synd.SyndEntry;
import com.sun.syndication.feed.synd.SyndEntryImpl;
import com.sun.syndication.feed.synd.SyndFeed;
import com.sun.syndication.feed.synd.SyndFeedImpl;
import com.sun.syndication.io.FeedException;

public class FeedService {

    public final String FEED_CACHE_KEY = this.getClass().getName()
        + ":"
        + "Feed";

    /**
     * RSS Feedを取得
     *
     * @param <M>
     *
     * @return
     * @throws IOException
     * @throws FeedException
     */
    public SyndFeed getFeed(String title, String link, String description,
            List<Feed> modelList) {
        if (Memcache.contains(FEED_CACHE_KEY)) {
            return Memcache.get(FEED_CACHE_KEY);
        }
        SyndFeed feed = createFeed(title, link, description, modelList);
        Memcache.put(FEED_CACHE_KEY, feed);
        return feed;
    }

    /**
     * RSS Feedを生成
     *
     * @param <M>
     *
     * @return
     * @throws IOException
     * @throws FeedException
     */
    protected SyndFeed createFeed(String title, String link,
            String description, List<Feed> modelList) {
        SyndFeed feed = new SyndFeedImpl();
        feed.setTitle(title);
        feed.setLink(link);
        feed.setDescription(description);

        List<SyndEntry> entries = new ArrayList<SyndEntry>();

        for (Feed model : modelList) {
            entries.add(buildeEntry(model));
        }

        feed.setEntries(entries);

        return feed;
    }

    /**
     * SyndEntryを作成
     *
     * @param <M>
     *
     * @param M
     * @return
     */
    public SyndEntry buildeEntry(Feed model) {
        SyndEntry entry = new SyndEntryImpl();
        entry.setTitle(model.getTitle());
        entry.setLink(model.getLink());
        entry.setPublishedDate(model.getPublishedDate());

        SyndContent description = new SyndContentImpl();
        description.setType("text/plain");
        description.setValue(model.getDescription());

        entry.setDescription(description);
        return entry;
    }
}
