package jp.rte.core.service;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.StringReader;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.ArrayList;
import java.util.List;

import jp.rte.core.utils.init.ApplicationSettings;

import org.jdom.Document;
import org.jdom.Element;
import org.jdom.JDOMException;
import org.jdom.Namespace;
import org.jdom.input.SAXBuilder;

public class YahooKeyphraseService {

    /*
     * TODO: Replace key AJzbXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX with your key.
     * If you don't, you will get a 400 service error (bad request).
     */
    private static final String APP_ID = ApplicationSettings
        .getString("yahoo.appid");

    // API読み出し
    @SuppressWarnings("unchecked")
    public static ArrayList<String> CallAPI(String str) {
        ArrayList<String> arrayList = new ArrayList<String>();
        try {
            //API検出頻度を高めるため、スペース2つ分に置換
            str = str.replaceAll(" ", "  ");
            // APIコールの為のURL文字列を生成
            StringBuilder urlstr =
                new StringBuilder("http://jlp.yahooapis.jp/KeyphraseService/V1/extract");
            urlstr.append("?appid=");
            urlstr.append(APP_ID);
            urlstr.append("&sentence=");
            urlstr.append(java.net.URLEncoder.encode(str, "UTF-8"));

            // APIコールを実行
            URL url = new URL(urlstr.toString());
            InputStream input = url.openStream();
            BufferedReader reader =
                new BufferedReader(new InputStreamReader(input, "UTF-8"));
            String line;
            StringBuilder xmlres = new StringBuilder();
            while ((line = reader.readLine()) != null) {
                xmlres.append(line);
            }
            reader.close();

            // XML解析
            Document doc =
                new SAXBuilder().build(new StringReader(xmlres.toString()));
            Element root = doc.getRootElement();
            Namespace xmls = Namespace.getNamespace("", "urn:yahoo:jp:jlp:KeyphraseService");
            List<Element> wordList =
                root
                    .getChildren("Result", xmls);
            String[] resString = new String[wordList.size()];
            for (int i = 0; i < wordList.size(); i++) {
                resString[i] = wordList.get(i).getChildText("Keyphrase", xmls);
            }
            for (String string : resString) {
                arrayList.add(string);
            }

        } catch (MalformedURLException e) {
            // ...
        } catch (IOException e) {
            // ...
        }
        // ...
        catch (JDOMException e) {
            // TODO 自動生成された catch ブロック
            e.printStackTrace();
        }
        return arrayList;
    }
}